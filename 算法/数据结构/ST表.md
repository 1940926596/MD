# ST表

**ST表**（Sparse Table，**稀疏表**）是一种简单的数据结构，主要用来解决**RMQ**（Range Maximum/Minimum Query，**区间最大/最小值查询**）问题。它主要应用**倍增**的思想，可以实现`O(nlog⁡n) `预处理、 `O(1)` 查询。

所谓RMQ问题，以最大值为例，是假如有一个数列 `A`，给你一个区间 `[l,r] `，要求`max(Ai)`，其中`i∈[l,r]`。

## ST表的预处理

ST表使用一个二维数组f，对于范围内的所有`f[a][b]`，先算出并存储**max(A<sub>i</sub>) ( i∈[a,a+2<sup>b</sup>) )**（本文中的区间都是离散意义下的，只包含整数，所以此区间也可以写成**[a,a+2<sup>b</sup>−1]**，这称为**预处理**。查询时，再利用这些子区间算出待求区间的最大值。

```cpp
int f[MAXN][21]; // 第二维的大小根据数据范围决定，不小于log(MAXN)
for (int i = 1; i <= n; ++i)
    f[i][0] = read(); // 读入数据
for (int i = 1; i <= 20; ++i)
    for (int j = 1; j + (1 << i) - 1 <= n; ++j)
        f[j][i] = max(f[j][i - 1], f[j + (1 << (i - 1))][i - 1]);
```

**原理图**

![image-20230415153023530](C:/Users/19409/AppData/Roaming/Typora/typora-user-images/image-20230415153023530.png)

## ST 表的查询

查询时，我们需要找到两个 `[l,r] `的子区间，它们的并集恰是 `[l,r]`（子区间可以相交）。具体地说，我们要找的是一个整数 s ，两个子区间分别为 **[l,l+2<sup>s</sup>−1]**和**[r−2<sup>s</sup>+1,r] **。

**原理图**

![image-20230415153513902](C:/Users/19409/AppData/Roaming/Typora/typora-user-images/image-20230415153513902.png)

我们希望前一个子区间的右端点尽可能接近r。当**l+2<sup>s</sup>−1=r**时，有 `s=log2⁡(r−l+1) `（这时 **r−2<sup>s</sup>+1=l** 也成立）。

但因为s是整数，所以我们取 `s=⌊log2⁡(r−l+1)⌋ `。可以证明，这时两个子区间确实可以覆盖 [l,r] 。

每次计算log太花时间了，我们可以对log也进行一次递推的**预处理**：

```cpp
for (int i = 2; i <= n; ++i)
    Log2[i] = Log2[i / 2] + 1;
```

在线查询的代码如下：

```cpp
for (int i = 0; i < m; ++i)
{
    int l = read(), r = read();
    int s = Log2[r - l + 1];
    printf("%d\n", max(f[l][s], f[r - (1 << s) + 1][s]));
}
```

## ST原理

其实ST表不仅能处理最大值/最小值，凡是符合**结合律**且**可重复贡献**的信息查询都可以使用ST表高效进行。什么叫可重复贡献呢？设有一个二元运算 f(x,y) ，满足 f(a,a)=a ，则f是可重复贡献的。显然最大值、最小值、最大公因数、最小公倍数、按位或、按位与都符合这个条件。可重复贡献的意义在于，可以对两个交集不为空的区间进行信息合并。